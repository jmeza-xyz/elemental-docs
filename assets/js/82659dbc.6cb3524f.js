"use strict";(self.webpackChunkelemental_docs=self.webpackChunkelemental_docs||[]).push([[140],{3690:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>d,frontMatter:()=>r,metadata:()=>s,toc:()=>l});var a=t(74848),i=t(28453);const r={sidebar_label:"Certificate Authority Verification",title:""},c="Certificate Authority Verification",s={id:"certificate-authority",title:"",description:"The elemental-register and elemental-system-agent rely on the Rancher's Certificate Authority configuration to verify the MachineRegistration URL, and to remotely watch plans.",source:"@site/docs/certificate-authority.md",sourceDirName:".",slug:"/certificate-authority",permalink:"/next/certificate-authority",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{sidebar_label:"Certificate Authority Verification",title:""},sidebar:"docs",previous:{title:"Channels",permalink:"/next/channels"},next:{title:"Backup",permalink:"/next/backup"}},o={},l=[{value:"Private CA certificate lifecycle",id:"private-ca-certificate-lifecycle",level:2}];function h(e){const n={a:"a",br:"br",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",strong:"strong",...(0,i.R)(),...e.components},{Head:t}=n;return t||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Head",!0),(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t,{children:(0,a.jsx)("link",{rel:"canonical",href:"https://elemental.docs.rancher.com/certificate-authority"})}),"\n",(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"certificate-authority-verification",children:"Certificate Authority Verification"})}),"\n",(0,a.jsxs)(n.p,{children:["The ",(0,a.jsx)(n.code,{children:"elemental-register"})," and ",(0,a.jsx)(n.code,{children:"elemental-system-agent"})," rely on the ",(0,a.jsx)(n.a,{href:"https://ranchermanager.docs.rancher.com/getting-started/installation-and-upgrade/resources/update-rancher-certificate",children:"Rancher's Certificate Authority configuration"})," to verify the ",(0,a.jsx)(n.a,{href:"https://elemental.docs.rancher.com/machineregistration-reference#configelementalregistration",children:"MachineRegistration"})," URL, and to remotely watch plans."]}),"\n",(0,a.jsxs)(n.p,{children:["Depending on whether the Certificate Authority is private or public, you may want to instruct the agent to enforce ",(0,a.jsx)(n.code,{children:"strict"})," CA verification, or to use the system trust store instead."]}),"\n",(0,a.jsxs)(n.p,{children:["From Rancher ",(0,a.jsx)(n.code,{children:"2.9"}),", the ",(0,a.jsx)(n.a,{href:"https://ranchermanager.docs.rancher.com/getting-started/installation-and-upgrade/installation-references/tls-settings#agent-tls-enforcement",children:"agent-tls-mode"})," global setting will also apply to the installation of Elemental agents.",(0,a.jsx)(n.br,{}),"\n","Note that if the ",(0,a.jsx)(n.code,{children:"agent-tls-mode"})," setting changes, Elemental machines will need to be ",(0,a.jsx)(n.a,{href:"/next/reset",children:"reset"})," in order for the setting to apply."]}),"\n",(0,a.jsx)(n.h2,{id:"private-ca-certificate-lifecycle",children:"Private CA certificate lifecycle"}),"\n",(0,a.jsxs)(n.p,{children:["When using a private CA, the recommendation is to always make sure that the same CA is also used for Rancher.",(0,a.jsx)(n.br,{}),"\n","Elemental will make use of the ",(0,a.jsx)(n.code,{children:"cacerts"}),", when including the CA cert to be trusted by agents. This is the same value as it appears on the ",(0,a.jsx)(n.code,{children:"https://my.rancher.example/cacerts"})," URL."]}),"\n",(0,a.jsxs)(n.p,{children:["Note however that it will not be possible to update this value after an Elemental machine has been installed.",(0,a.jsx)(n.br,{}),"\n","Replacing the CA certificate on Rancher may lead to Elemental machines not being able to re-connect to Rancher and operating normally, when the ",(0,a.jsx)(n.code,{children:"agent-tls-mode"})," is set to ",(0,a.jsx)(n.code,{children:"strict"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["For this reason the recommendation is to use the ",(0,a.jsx)(n.code,{children:"agent-tls-mode: system-store"})," setting instead and manage the lifecycle of CA certs on Elemental machines directly, when a private Certificate Authority is in use."]}),"\n",(0,a.jsxs)(n.p,{children:["The CA cert can be installed in ",(0,a.jsx)(n.a,{href:"/next/custom-images",children:"custom OS images"})," directly, or passed as a cloud-init configuration in Elemental resources.",(0,a.jsx)(n.br,{}),"\n","For example the initial CA certificate can be included in the ",(0,a.jsx)(n.a,{href:"/next/machineregistration-reference#configcloud-config",children:"MachineRegistration"})," ",(0,a.jsx)(n.code,{children:"cloud-config"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:"apiVersion: elemental.cattle.io/v1beta1\nkind: MachineRegistration\nmetadata:\n  name: fire-nodes\n  namespace: fleet-default\nspec:\n  config:\n    cloud-config:\n      write_files:\n        - path: /etc/pki/trust/anchors/rancher-ca.pem\n          permission: 0444\n          content: |-\n            -----BEGIN CERTIFICATE-----\n            MIIDETCCAfmgAwIBAgIRAK0J3NrgPllXUiGYrA9sTlUwDQYJKoZIhvcNAQELBQAw\n            IjEgMB4GA1UEAxMXZWxlbWVudGFsLXNlbGZzaWduZWQtY2EwHhcNMjQxMDA3MTEw\n            ODM5WhcNMzUwODAxMTEwODM5WjAiMSAwHgYDVQQDExdlbGVtZW50YWwtc2VsZnNp\n            Z25lZC1jYTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAJm2esaQL82b\n            rWMpnurmyiutruWvdWUT0Dci2+I7vI1CRs7Gqq93in3+HOoEuaJhS4eZQT9AFyaq\n            msijMa3cTYUDhTbOAvPs27E/mSBeQyKd/hJuQ0B8vl47Z1ixOpUHdMOBsZDI0XF5\n            yjVTj4nTZXW5n0zZpnmEs4DhLJLJc6icjQLdHDsSj/LeTy8alyTtkOaWcPjFppNI\n            6M5a1BWJPhNKGlFpezqfjtJogxbOEAohpN4DUKvqebRWnC+4MjhqUcEW5sXatFTH\n            F7MGbVSqQk/f7lzIuke4nvWd0FGPyk/sD31rXT2/2eHkcTJEanRq3bwWQNXQynQ1\n            wdqIH1TtfMUCAwEAAaNCMEAwDgYDVR0PAQH/BAQDAgKkMA8GA1UdEwEB/wQFMAMB\n            Af8wHQYDVR0OBBYEFIv2OZVFAhh8HzoEwjlf5GivNf6IMA0GCSqGSIb3DQEBCwUA\n            A4IBAQAfNUNQKZ02oTo9q+/nbS8kIuhwzSTtNzKflQU5oibpDSAxYlx2gsYqppb/\n            w7voj+GiONQR22PrCFh+Kr7aGr/GZh6oXg47dK4Es2dVeE8qdqW3WtZ8oj/OJxmP\n            7TqWZdGf7TAxfgNzIpGjWFw/coJ7dcYbDrcZFWG5oQpTbLHK/ECMPWytGVRjrqE6\n            baLJ85AVqF9rcCb0giXzvzS6/IpyAe7+Q4WvdzY1uaLQSwkBtpt9OM/O35GmeFUR\n            OUkPxQ15e+3tUnDLUDnkTk3xMVRvJehnk/I75auqlUra55KLqfd6SUEbGP3MU9ZI\n            12xVJHQTSN8XWh0++9jNG0eSMe75\n            -----END CERTIFICATE-----\n      runcmd:\n        - update-ca-certificates\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Before the CA cert is replaced on Rancher, the new CA cert can be included on Elemental machines by upgrading them.",(0,a.jsx)(n.br,{}),"\n","The ",(0,a.jsx)(n.strong,{children:"new"})," CA cert can be configured in the ",(0,a.jsx)(n.a,{href:"/next/managedosimage-reference#cloudconfig",children:"ManagedOSImage"})," ",(0,a.jsx)(n.code,{children:"cloudConfig"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",children:'apiVersion: elemental.cattle.io/v1beta1\nkind: ManagedOSImage\nmetadata:\n  name: ca-cert-upgrade\n  namespace: fleet-default\nspec:\n  # The cloudConfig will be applied after node reboot\n  cloudConfig:\n    write_files:\n      - path: /etc/pki/trust/anchors/rancher-ca-new.pem\n        permission: 0444\n        content: |-\n          -----BEGIN CERTIFICATE-----\n          MIIDEDCCAfigAwIBAgIQVgcMnY4HFB5+bZ9yhLaFkTANBgkqhkiG9w0BAQsFADAi\n          MSAwHgYDVQQDExdlbGVtZW50YWwtc2VsZnNpZ25lZC1jYTAeFw0yNDEwMDcxMjUx\n          MzZaFw0zNTA4MDExMjUxMzZaMCIxIDAeBgNVBAMTF2VsZW1lbnRhbC1zZWxmc2ln\n          bmVkLWNhMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvwokj48hQFF3\n          +v/ObqPOOyYszL/Nyv8/BomPgBia/GXGe8mkQHEWUXFS4P6KdMGQQU3X6Pm071qG\n          QEWEIy95szy1H/q1DgZQCM5fjYPcfFJMopQ28vJEk58/9PePr/GZRWAeAhmMKZeg\n          HP/wpuUMEdEh7vGYjKjVuIJiFgT2lVDKqrtRIon+L1iIP3IRmVa49UzmdW2wM79W\n          a1nv52+EZaw3UDSLPonvs29AZG8M+NuENlefHWEwYVpDEwF9lXinfL3wMw36gIo4\n          X4LmStP9WU4mvglrR8Zwj1M9COMrYbBYQ86jUGM0L0eNG52Uflsn+0ttLRhgkpba\n          wAl8jAZWdQIDAQABo0IwQDAOBgNVHQ8BAf8EBAMCAqQwDwYDVR0TAQH/BAUwAwEB\n          /zAdBgNVHQ4EFgQUmOGv0AwumUlwQDdULL2dLik/6FUwDQYJKoZIhvcNAQELBQAD\n          ggEBACMmDLbKOgz5Zo1pSLTYc08Nb5sRTK/bW24IZ67cfdPstvTQBDAH5+obAjus\n          N2Linl/IAsN8K2cnoBq1gM3sST+YDVOBdItZXwe8jybk3IoJPdzE63l//ReTyTSg\n          OamwUR6qHcLZ9XNwS4z8WYNy3mDLO6dgq7udb2DHm/0mvyi3Q0oRvsrI+9JCCrgz\n          YTFWEWhbpfUzH+dheISMYJx3l/iIFJajaASWKtGBMnp9G+RC2HhDcDwBnW/4JT1h\n          wqvat7kdRIxcWHtW482JKRyfa58QidqA7nIBblZJuWqpo4etAVZTCV/caFKbn/Ek\n          FrT88MNiy5xsimgQSdt9vptOvJc=\n          -----END CERTIFICATE-----\n    runcmd:\n      - update-ca-certificates\n  osImage: "registry.suse.com/suse/sl-micro/6.0/baremetal-os-container:2.1.2-3.59"\n  clusterTargets:\n    - clusterName: volcano\n  upgradeContainer:\n    envs:\n      # Use FORCE to force an upgrade. \n      # This is convenient when the `osImage` is the same, and only the `cloudConfig` changed.\n      - name: FORCE\n        value: "false"\n'})})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(h,{...e})}):h(e)}},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>s});var a=t(96540);const i={},r=a.createContext(i);function c(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);